<!-- Loading State -->
@if (isLoading()) {
<div class="loading-container">
  <div class="container py-5">
    <div class="text-center mb-5">
      <mat-spinner class="mx-auto"></mat-spinner>
      <p class="mt-3 text-muted">Loading field details...</p>
    </div>
    
    <!-- Skeleton Loaders -->
    <div class="row g-4">
      <div class="col-lg-8">
        <div class="skeleton skeleton-image"></div>
      </div>
      <div class="col-lg-4">
        <div class="skeleton skeleton-card mb-3"></div>
        <div class="skeleton skeleton-card"></div>
      </div>
    </div>
  </div>
</div>
}

<!-- Error State -->
@else if (hasError()) {
<div class="error-container">
  <div class="container py-5">
    <div class="error-card text-center">
      <mat-icon class="error-icon">error_outline</mat-icon>
      <h2 class="mt-3">Oops! Something went wrong</h2>
      <p class="text-muted">{{ errorMessage() }}</p>
      <button mat-raised-button color="primary" (click)="goBack()" class="mt-3">
        <mat-icon>arrow_back</mat-icon>
        Back to Fields
      </button>
    </div>
  </div>
</div>
}

<!-- Main Content -->
@else if (field(); as fieldData) {
<div class="field-details-container">
  <!-- Header Section with Back Button -->
  <div class="header-section">
    <div class="container">
      <button mat-icon-button (click)="goBack()" class="back-button">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="field-header">
        <h1 class="field-title">{{ fieldData.name }}</h1>
        <div class="field-meta">
          <span class="category-badge">
            <mat-icon>sports_soccer</mat-icon>
            {{ fieldData.categoryName }}
          </span>
          <span class="location-badge">
            <mat-icon>location_on</mat-icon>
            {{ fieldData.cityName }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="container main-content">
    <div class="row g-4 mb-5">
      <!-- Image Gallery Section -->
      <div class="col-lg-8">
        <div class="image-gallery-card">
          @if (hasImages()) {
          <div class="main-image-container">
            <img
              [src]="currentImage()?.imageUrl"
              [alt]="'Image of ' + fieldData.name"
              class="main-image"
            />
            
            <!-- Navigation Arrows -->
            @if (fieldData.fieldImages.length > 1) {
            <button mat-icon-button class="nav-arrow nav-arrow-left" (click)="previousImage()">
              <mat-icon>chevron_left</mat-icon>
            </button>
            <button mat-icon-button class="nav-arrow nav-arrow-right" (click)="nextImage()">
              <mat-icon>chevron_right</mat-icon>
            </button>
            
            <!-- Image Counter -->
            <div class="image-counter">
              {{ selectedImageIndex() + 1 }} / {{ fieldData.fieldImages.length }}
            </div>
            }
          </div>
          
          <!-- Thumbnail Gallery -->
          @if (fieldData.fieldImages.length > 1) {
          <div class="thumbnail-gallery">
            @for (image of fieldData.fieldImages; track image.id; let idx = $index) {
            <div 
              class="thumbnail-item" 
              [class.active]="idx === selectedImageIndex()"
              (click)="selectImage(idx)"
            >
              <img [src]="image.imageUrl" [alt]="'Thumbnail ' + (idx + 1)" />
            </div>
            }
          </div>
          }
          } @else {
          <div class="no-image-placeholder">
            <mat-icon>image_not_supported</mat-icon>
            <p>No images available</p>
          </div>
          }
        </div>
      </div>

      <!-- Info Cards Section -->
      <div class="col-lg-4">
        <!-- Field Details Card -->
        <mat-card class="info-card details-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>info</mat-icon>
              Field Details
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="info-list">
              <div class="info-item">
                <mat-icon>straighten</mat-icon>
                <div class="info-content">
                  <span class="info-label">Size</span>
                  <span class="info-value">{{ formatSize(fieldData.size) }}</span>
                </div>
              </div>
              
              <div class="info-item">
                <mat-icon>schedule</mat-icon>
                <div class="info-content">
                  <span class="info-label">Operating Hours</span>
                  <span class="info-value">{{ fieldData.openAt }}:00 - {{ fieldData.closeAt }}:00</span>
                </div>
              </div>
              
              <div class="info-item price-item">
                <mat-icon>payments</mat-icon>
                <div class="info-content">
                  <span class="info-label">Price per Hour</span>
                  <span class="info-value price-value">
                    {{ fieldData.pricePerHour | currency : 'EGP' : 'symbol' : '1.0-0' }}
                  </span>
                </div>
              </div>

              <div class="info-item">
                <mat-icon>person</mat-icon>
                <div class="info-content">
                  <span class="info-label">Owner</span>
                  <button mat-button class="info-value owner-link" (click)="openUserContactInfo($event)">
                    {{ fieldData.ownerName }}
                  </button>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Location Card -->
        <mat-card class="info-card location-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>location_on</mat-icon>
              Location
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <p class="location-address">
              <mat-icon>place</mat-icon>
              {{ fieldData.location }}, {{ fieldData.cityName }}
            </p>
            <div class="location-actions">
              <button 
                mat-raised-button 
                color="primary" 
                (click)="scrollToMap()" 
                class="w-100 mb-2"
              >
                <mat-icon>map</mat-icon>
                View on Map
              </button>
              <button 
                mat-stroked-button 
                (click)="openMapInNewTab()" 
                class="w-100"
              >
                <mat-icon>open_in_new</mat-icon>
                Open in Google Maps
              </button>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    <!-- Time Slots Section -->
    <section class="time-slot-section">
      <div class="section-header">
        <h2 class="section-title">
          <mat-icon>event_available</mat-icon>
          Available Time Slots
        </h2>
        <p class="section-subtitle">Select a time slot to book your game</p>
      </div>
      <app-time-slot [fieldSignal]="fieldData"></app-time-slot>
    </section>

    <!-- Description Section -->
    <div class="row mb-4">
      <div class="col-12">
        <mat-card class="description-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>description</mat-icon>
              About This Field
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <p class="description-text">
              A modern and well-maintained football field located in {{ fieldData.cityName }}. 
              Perfect for evening games with friends or competitive league matches. 
              The field features quality turf and is regularly maintained to ensure the best playing experience.
            </p>
            <div class="features-list">
              <div class="feature-item">
                <mat-icon>check_circle</mat-icon>
                <span>Quality Surface</span>
              </div>
              <div class="feature-item">
                <mat-icon>check_circle</mat-icon>
                <span>Well Lit</span>
              </div>
              <div class="feature-item">
                <mat-icon>check_circle</mat-icon>
                <span>Convenient Location</span>
              </div>
              <div class="feature-item">
                <mat-icon>check_circle</mat-icon>
                <span>Regular Maintenance</span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    <!-- Map Section -->
    <div class="row mb-5">
      <div class="col-12">
        <mat-card id="google-map" class="map-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>map</mat-icon>
              Location Map
            </mat-card-title>
          </mat-card-header>
          <mat-card-content class="p-0">
            <div class="map-container">
              <iframe
                [src]="getSafeMapUrl(fieldData.location, fieldData.cityName)"
                width="100%"
                height="450"
                style="border: 0"
                allowfullscreen=""
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"
              ></iframe>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>
  </div>
</div>
}
