<div class="profile-page">
  <div class="profile-container">
    @if (loading()) {
    <div class="loading-state">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Loading profile...</p>
    </div>
    } @else if (userProfile()) {
    <div class="profile-header">
      <div class="profile-avatar">
        <mat-icon class="avatar-icon">account_circle</mat-icon>
      </div>
      <div class="profile-info">
        <h1 class="profile-name">{{ userProfile()?.name || userProfile()?.userName }}</h1>
        <p class="profile-email">{{ userProfile()?.email }}</p>
        <span class="profile-role" [class.owner]="userProfile()?.roles?.includes('FieldOwner')">
          <mat-icon>{{ userProfile()?.roles?.includes('FieldOwner') ? 'store' : 'person' }}</mat-icon>
          {{ userProfile()?.roles?.includes('FieldOwner') ? 'Field Owner' : 'Player' }}
        </span>
      </div>
    </div>

    <mat-tab-group class="profile-tabs" animationDuration="300ms">
      <!-- Profile Information Tab -->
      <mat-tab label="Profile Information">
        <div class="tab-content">
          <mat-card class="info-card">
            <mat-card-header>
              <mat-card-title class="card-title">
                <mat-icon>person</mat-icon>
                Personal Information
              </mat-card-title>
              <button
                mat-icon-button
                class="edit-button"
                (click)="toggleEditMode()"
                [attr.aria-label]="editMode() ? 'Cancel' : 'Edit'"
              >
                <mat-icon>{{ editMode() ? 'close' : 'edit' }}</mat-icon>
              </button>
            </mat-card-header>
            <mat-card-content>
              <form [formGroup]="profileForm" class="profile-form">
                <div class="form-group">
                  <label class="form-label">
                    <mat-icon>badge</mat-icon>
                    Full Name
                  </label>
                  @if (editMode()) {
                  <input
                    type="text"
                    formControlName="name"
                    class="form-input"
                    placeholder="Enter your name"
                  />
                  @if (profileForm.get('name')?.touched && profileForm.get('name')?.errors) {
                  <div class="error-message">
                    <mat-icon>error</mat-icon>
                    Name is required
                  </div>
                  }
                  } @else {
                  <p class="form-value">{{ userProfile()?.name }}</p>
                  }
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <mat-icon>alternate_email</mat-icon>
                    Username
                  </label>
                  <p class="form-value">{{ userProfile()?.userName }}</p>
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <mat-icon>phone</mat-icon>
                    Phone Number
                  </label>
                  @if (editMode()) {
                  <input
                    type="text"
                    formControlName="phoneNumber"
                    class="form-input"
                    placeholder="01X XXXX XXXX"
                  />
                  @if (profileForm.get('phoneNumber')?.touched && profileForm.get('phoneNumber')?.errors) {
                  <div class="error-message">
                    <mat-icon>error</mat-icon>
                    Invalid phone number format
                  </div>
                  }
                  } @else {
                  <p class="form-value">{{ userProfile()?.phoneNumber }}</p>
                  }
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <mat-icon>location_on</mat-icon>
                    Location
                  </label>
                  @if (editMode()) {
                  <input
                    type="text"
                    formControlName="location"
                    class="form-input"
                    placeholder="Enter your location"
                  />
                  } @else {
                  <p class="form-value">{{ userProfile()?.location || 'Not specified' }}</p>
                  }
                </div>

                @if (editMode()) {
                <div class="form-actions">
                  <button
                    mat-raised-button
                    class="cancel-button"
                    type="button"
                    (click)="toggleEditMode()"
                  >
                    <mat-icon>close</mat-icon>
                    Cancel
                  </button>
                  <button
                    mat-raised-button
                    color="primary"
                    class="save-button"
                    type="button"
                    (click)="saveProfile()"
                    [disabled]="profileForm.invalid"
                  >
                    <mat-icon>save</mat-icon>
                    Save Changes
                  </button>
                </div>
                }
              </form>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Security Tab -->
      <mat-tab label="Security">
        <div class="tab-content">
          <mat-card class="info-card">
            <mat-card-header>
              <mat-card-title class="card-title">
                <mat-icon>security</mat-icon>
                Change Password
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <form [formGroup]="changePasswordForm" (ngSubmit)="changePassword()" class="password-form">
                <div class="form-group">
                  <label class="form-label">
                    <mat-icon>lock</mat-icon>
                    Current Password
                  </label>
                  <div class="password-wrapper">
                    <input
                      [type]="showCurrentPassword ? 'text' : 'password'"
                      formControlName="currentPassword"
                      class="form-input"
                      placeholder="Enter current password"
                    />
                    <button
                      type="button"
                      mat-icon-button
                      class="visibility-toggle"
                      (click)="toggleCurrentPasswordVisibility()"
                    >
                      <mat-icon>{{ showCurrentPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
                    </button>
                  </div>
                  @if (changePasswordForm.get('currentPassword')?.touched && changePasswordForm.get('currentPassword')?.errors) {
                  <div class="error-message">
                    <mat-icon>error</mat-icon>
                    Current password is required
                  </div>
                  }
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <mat-icon>lock_open</mat-icon>
                    New Password
                  </label>
                  <div class="password-wrapper">
                    <input
                      [type]="showNewPassword ? 'text' : 'password'"
                      formControlName="newPassword"
                      class="form-input"
                      placeholder="Enter new password"
                    />
                    <button
                      type="button"
                      mat-icon-button
                      class="visibility-toggle"
                      (click)="toggleNewPasswordVisibility()"
                    >
                      <mat-icon>{{ showNewPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
                    </button>
                  </div>
                  @if (changePasswordForm.get('newPassword')?.touched && changePasswordForm.get('newPassword')?.errors) {
                  <div class="error-message">
                    <mat-icon>error</mat-icon>
                    Password must be at least 6 characters
                  </div>
                  }
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <mat-icon>lock_clock</mat-icon>
                    Confirm New Password
                  </label>
                  <div class="password-wrapper">
                    <input
                      [type]="showConfirmPassword ? 'text' : 'password'"
                      formControlName="confirmPassword"
                      class="form-input"
                      placeholder="Confirm new password"
                    />
                    <button
                      type="button"
                      mat-icon-button
                      class="visibility-toggle"
                      (click)="toggleConfirmPasswordVisibility()"
                    >
                      <mat-icon>{{ showConfirmPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
                    </button>
                  </div>
                  @if (changePasswordForm.get('confirmPassword')?.touched && changePasswordForm.get('confirmPassword')?.errors) {
                  <div class="error-message">
                    <mat-icon>error</mat-icon>
                    Please confirm your password
                  </div>
                  }
                  @if (changePasswordForm.get('confirmPassword')?.touched && changePasswordForm.errors?.['passwordMismatch']) {
                  <div class="error-message">
                    <mat-icon>error</mat-icon>
                    Passwords do not match
                  </div>
                  }
                </div>

                <div class="form-actions">
                  <button
                    mat-raised-button
                    color="primary"
                    type="submit"
                    [disabled]="changePasswordForm.invalid"
                    class="save-button"
                  >
                    <mat-icon>check</mat-icon>
                    Update Password
                  </button>
                </div>
              </form>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Account Settings Tab -->
      <mat-tab label="Account Settings">
        <div class="tab-content">
          <!-- Change Username -->
          <mat-card class="info-card">
            <mat-card-header>
              <mat-card-title class="card-title">
                <mat-icon>alternate_email</mat-icon>
                Change Username
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <form [formGroup]="changeUsernameForm" (ngSubmit)="changeUsername()" class="account-form">
                <div class="form-group">
                  <label class="form-label">
                    <mat-icon>person_outline</mat-icon>
                    Current Username
                  </label>
                  <p class="current-value">{{ userProfile()?.userName }}</p>
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <mat-icon>edit</mat-icon>
                    New Username
                  </label>
                  <input
                    type="text"
                    formControlName="newUserName"
                    class="form-input"
                    placeholder="Enter new username"
                  />
                  @if (changeUsernameForm.get('newUserName')?.touched && changeUsernameForm.get('newUserName')?.errors) {
                  <div class="error-message">
                    <mat-icon>error</mat-icon>
                    Username is required
                  </div>
                  }
                </div>

                <div class="form-actions">
                  <button
                    mat-raised-button
                    color="primary"
                    type="submit"
                    [disabled]="changeUsernameForm.invalid"
                    class="save-button"
                  >
                    <mat-icon>check</mat-icon>
                    Update Username
                  </button>
                </div>
              </form>
            </mat-card-content>
          </mat-card>

          <!-- Change Email -->
          <mat-card class="info-card">
            <mat-card-header>
              <mat-card-title class="card-title">
                <mat-icon>email</mat-icon>
                Change Email
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <form [formGroup]="changeEmailForm" (ngSubmit)="requestEmailChange()" class="account-form">
                <div class="form-group">
                  <label class="form-label">
                    <mat-icon>mail_outline</mat-icon>
                    Current Email
                  </label>
                  <p class="current-value">{{ userProfile()?.email }}</p>
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <mat-icon>edit</mat-icon>
                    New Email
                  </label>
                  <input
                    type="email"
                    formControlName="newEmail"
                    class="form-input"
                    placeholder="Enter new email address"
                  />
                  @if (changeEmailForm.get('newEmail')?.touched && changeEmailForm.get('newEmail')?.errors?.['required']) {
                  <div class="error-message">
                    <mat-icon>error</mat-icon>
                    Email is required
                  </div>
                  }
                  @if (changeEmailForm.get('newEmail')?.touched && changeEmailForm.get('newEmail')?.errors?.['email']) {
                  <div class="error-message">
                    <mat-icon>error</mat-icon>
                    Please enter a valid email
                  </div>
                  }
                </div>

                <div class="form-actions">
                  <button
                    mat-raised-button
                    color="primary"
                    type="submit"
                    [disabled]="changeEmailForm.invalid"
                    class="save-button"
                  >
                    <mat-icon>check</mat-icon>
                    Request Email Change
                  </button>
                </div>
              </form>

              @if (emailChangeRequested()) {
              <div class="info-box">
                <mat-icon>info</mat-icon>
                <p>
                  A confirmation email has been sent to your new email address. 
                  Please check your inbox and click the confirmation link to complete the process.
                </p>
              </div>
              }
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>
    </mat-tab-group>

    <div class="profile-actions">
      <button mat-stroked-button class="logout-button" (click)="logout()">
        <mat-icon>logout</mat-icon>
        Logout
      </button>
    </div>
    }
  </div>
</div>
